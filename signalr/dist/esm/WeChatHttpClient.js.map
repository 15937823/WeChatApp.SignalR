{"version":3,"file":"WeChatHttpClient.js","sourceRoot":"","sources":["../../src/WeChatHttpClient.ts"],"names":[],"mappings":"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","sourcesContent":["import { AbortError, HttpError } from \"./Errors\";\r\nimport { HttpClient, HttpRequest, HttpResponse } from \"./HttpClient\";\r\nimport { ILogger, LogLevel } from \"./ILogger\";\r\n\r\nexport class WeChatHttpClient extends HttpClient {\r\n\r\n    constructor(private readonly logger: ILogger) {\r\n        super();\r\n    }\r\n\r\n    /** @inheritdoc */\r\n    public send(request: HttpRequest): Promise<HttpResponse> {\r\n        // Check that abort was not signaled before calling send\r\n        if (request.abortSignal && request.abortSignal.aborted) {\r\n            return Promise.reject(new AbortError());\r\n        }\r\n\r\n        if (!request.method) {\r\n            return Promise.reject(new Error(\"No method defined.\"));\r\n        }\r\n        if (!request.url) {\r\n            return Promise.reject(new Error(\"No url defined.\"));\r\n        }\r\n\r\n        return new Promise<HttpResponse>((resolve, reject) => {\r\n            const xhr = wx.request({\r\n                data: request.content,\r\n                method: request.method as any,\r\n                url: request.url!,\r\n                header: {\r\n                    ...request.headers,\r\n                    \"X-Requested-With\": \"XMLHttpRequest\",\r\n                    \"Content-Type\": \"text/plain;charset=UTF-8\"\r\n                },\r\n                fail: (response) => {\r\n                    this.logger.log(LogLevel.Warning, `Error from HTTP request. ${response.errMsg}.`);\r\n                    reject(new HttpError(response.errMsg, 500)); // no status code\r\n                },\r\n                success: (response) => {\r\n                    if (request.abortSignal) {\r\n                        request.abortSignal.onabort = null;\r\n                    }\r\n\r\n                    if (response.statusCode >= 200 && response.statusCode < 300) {\r\n                        let content: string;\r\n                        if (typeof response.data === \"object\") {\r\n                            content = JSON.stringify(response.data);\r\n                        } else {\r\n                            content = response.data;\r\n                        }\r\n                        resolve(new HttpResponse(response.statusCode, this.mapStatusCode(response.statusCode), content));\r\n                    } else {\r\n                        reject(new HttpError(response.errMsg, response.statusCode));\r\n                    }\r\n                }\r\n            });\r\n\r\n            if (request.abortSignal) {\r\n                request.abortSignal.onabort = () => {\r\n                    xhr.abort();\r\n                    reject(new AbortError());\r\n                };\r\n            }\r\n\r\n            // timeout is not supported in wx.request()\r\n            // if (request.timeout) {\r\n            //     xhr.timeout = request.timeout;\r\n            // }\r\n\r\n            // timeout is not supported in wx.request()\r\n            // xhr.ontimeout = () => {\r\n            //     this.logger.log(LogLevel.Warning, `Timeout from HTTP request.`);\r\n            //     reject(new TimeoutError());\r\n            // };\r\n        });\r\n    }\r\n\r\n    private knownStateTextMap = {\r\n        [100]: \"Continue\",\r\n        [101]: \"Switching Protocols\",\r\n        [102]: \"Processing\",\r\n        [200]: \"Ok\",\r\n        [201]: \"Created\",\r\n        [202]: \"Accepted\",\r\n        [203]: \"Non-Authoritative Information\",\r\n        [204]: \"No Content\",\r\n        [205]: \"Reset Content\",\r\n        [206]: \"Partial Content\",\r\n        [207]: \"Multi-Status\",\r\n        [300]: \"Multiple Choices\",\r\n        [301]: \"Moved Permanently\",\r\n        [302]: \"Move Temporarily\",\r\n        [303]: \"See Other\",\r\n        [304]: \"Not Modified\",\r\n        [305]: \"Use Proxy\",\r\n        [306]: \"Switch Proxy\",\r\n        [307]: \"Temporary Redirect\",\r\n        [400]: \"Bad Request\",\r\n        [401]: \"Unauthenticated\",\r\n        [402]: \"Payment Required\",\r\n        [403]: \"Forbidden\",\r\n        [404]: \"Not Found\",\r\n        [405]: \"Method Not Allowed\",\r\n        [406]: \"Not Acceptable\",\r\n        [408]: \"Request Timeout\",\r\n        [415]: \"Unsupported Media Type\",\r\n        [500]: \"Internal Server Error\",\r\n        [501]: \"Not Implemented\",\r\n        [502]: \"Bad Gateway\",\r\n        [503]: \"Service Unavailable\",\r\n        [600]: \"Unparseable Response Headers\"\r\n    };\r\n\r\n    private mapStatusCode(statusCode: number): string {\r\n        const x = this.knownStateTextMap[statusCode];\r\n        if (x) {\r\n            return x;\r\n        }\r\n        return \"unknow state\";\r\n    }\r\n}\r\n"]}